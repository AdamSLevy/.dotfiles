#!/bin/bash -
set -o nounset # Treat unset variables as an error

SUDOERS=/etc/pam.d/sudo

AUTH="auth       sufficient     pam_tid.so"

TEMP="$(mktemp)"

if grep -q "$AUTH" "$SUDOERS"; then
  echo "already done"
  exit 0
fi

echo "updating $SUDOERS"

if [[ $(id -u) -ne 0 ]]; then
  echo "error: not running as root"
  exit 1
fi

chmod u+w "$SUDOERS" || exit 1
echo "$AUTH" | cat - "$SUDOERS" >"$TEMP" &&
  mv "$TEMP" "$SUDOERS" &&
  echo "done"
chmod u-w "$SUDOERS"
