#!/bin/bash

set -Eeuo pipefail

function usage() {
  error "Usage: "
  error
  error "$(basename $0) <Secret Name> <Secret Key> [-p|--print] [-e|--no-fail-empty]"
}

function nop() {
  :
}

function echo-stderr() {
  echo "$@" >&2
}

COPY="pbcopy"
EMPTY="exit 1"

while [[ $# -gt 0 ]]; do
  case $1 in
    -p | --print)
      COPY="cat"
      shift # past argument
      ;;
    -e | --no-fail-empty)
      EMPTY="nop"
      shift # past argument
      ;;
    -* | --*)
      echo-stderr "Unknown option $1"
      echo-stderr
      usage
      exit 1
      ;;
    *)
      POSITIONAL_ARGS+=("$1") # save positional arg
      shift                   # past argument
      ;;
  esac
done

set -- "${POSITIONAL_ARGS[@]}" # restore positional parameters

if [[ $# != 2 ]]; then
  echo-stderr "error: invalid number of arguments"
  echo-stderr
  usage
  exit 1
fi

SECRET=$1
KEY=$2

DATA=$(kubectl get secret "$SECRET" -o jsonpath='{.data.'$KEY'}' | base64 -d)

if [[ -z "$DATA" ]]; then
  echo-stderr "secret was empty"
  $EMPTY
fi

echo $DATA | $COPY

if [[ $COPY == pbcopy ]]; then
  echo-stderr "secret copied to clipboard"
fi
